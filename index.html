<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>产品报价选品表 - 智能搜索</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    
    /* 背景轮播容器 */
    .bg-slideshow {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -2;
      overflow: hidden;
    }
    
    .bg-slideshow .slide {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0;
      transition: opacity 1.5s ease-in-out;
    }
    
    .bg-slideshow .slide.active {
      opacity: 1;
    }
    
    /* 渐变遮罩 - 确保内容可读性 */
    .bg-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(249, 250, 251, 0.85) 0%, rgba(229, 231, 235, 0.75) 100%);
      z-index: -1;
    }
    
    /* 其他原有样式保持不变 */
    body { 
      background: #f9fafb;
      padding-top: 16px;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }

    /* 置顶头部区域 - 更紧凑 */
    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #f9fafb;
      padding: 16px 0 0;
      margin: -16px 0 16px;
    }

    /* 标题样式 - 更紧凑 */
    header { text-align: center; margin-bottom: 16px; }
    h1 { font-size: 1.8rem; color: #1e293b; margin-bottom: 6px; }
    .subtitle { color: #64748b; font-size: 0.9rem; }

    /* 筛选区 - 更紧凑布局 */
    .filters {
      background: white;
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      position: relative;
      transition: all 0.3s ease;
    }
    .filter-row { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 10px;
      margin-bottom: 10px;
    }
    .filter-group { 
      flex: 1; 
      min-width: 130px;
    }
    .filter-group-compact {
      min-width: 110px;
      flex: 0.8;
    }
    .filter-group-wide {
      flex: 2;
      min-width: 220px;
    }
    .search-group {
      min-width: 280px;
      flex: 2;
    }
    label { 
      display: block; 
      font-weight: 600; 
      margin-bottom: 5px;
      font-size: 12px;
      color: #374151;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    select, input { 
      width: 100%; 
      padding: 7px 9px;
      border: 1px solid #d1d5db; 
      border-radius: 5px;
      font-size: 12px;
      transition: border 0.2s; 
    }
    select:focus, input:focus { 
      outline: none; 
      border-color: #3b82f6; 
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); 
    }
    
    .multi-select { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 5px;
      margin-top: 4px; 
      max-height: 70px;
      overflow-y: auto; 
      padding: 5px;
      background: #f8fafc;
      border-radius: 4px;
    }
    .multi-select label { 
      display: flex; 
      align-items: center; 
      gap: 4px; 
      font-weight: normal; 
      font-size: 11px;
      cursor: pointer; 
      white-space: nowrap; 
      margin-bottom: 0;
    }
    .multi-select input { 
      width: auto; 
    }

    /* 筛选条件指示器 */
    .filter-indicators {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #e5e7eb;
    }
    .filter-tag {
      display: flex;
      align-items: center;
      gap: 5px;
      background: #e0f2fe;
      color: #0369a1;
      padding: 3px 8px;
      border-radius: 14px;
      font-size: 11px;
      font-weight: 500;
    }
    .filter-tag .remove {
      cursor: pointer;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #bae6fd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
    }
    .filter-tag .remove:hover {
      background: #7dd3fc;
    }

    /* 选品统计栏 - 更紧凑 */
    .cart-summary {
      background: linear-gradient(135deg, #0ea5e9, #3b82f6);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
      box-shadow: 0 3px 8px rgba(14, 165, 233, 0.25);
    }
    .cart-info { font-size: 14px; font-weight: 600; }
    .cart-actions button {
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
      font-size: 12px;
    }
    .cart-actions button:hover { background: rgba(255, 255, 255, 0.3); }

    /* 商品列表 */
    .products { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
    .product-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s;
      /* 添加硬件加速优化 */
      transform: translateZ(0);
      backface-visibility: hidden;
      perspective: 1000px;
    }
    .product-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.08);
    }
    
    /* 优化图片展示区域 - 更合适的边距 */
    .product-img-container {
      position: relative;
      width: 100%;
      height: 170px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border-bottom: 1px solid #eee;
      padding: 8px;
    }
    .product-img {
      max-width: 94%;
      max-height: 94%;
      object-fit: contain;
      transition: transform 0.3s ease;
      border-radius: 4px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }
    .product-card:hover .product-img {
      transform: scale(1.04);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .no-image {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #9ca3af;
      font-size: 12px;
    }
    .no-image svg {
      width: 42px;
      height: 42px;
      margin-bottom: 5px;
      opacity: 0.5;
    }
    
    .product-body { padding: 12px; }
    .product-brand { color: #6b7280; font-size: 11px; margin-bottom: 3px; }
    .product-name { font-weight: 600; font-size: 13px; margin-bottom: 5px; word-break: break-word; line-height: 1.3; }
    .product-spec { color: #4b5563; font-size: 11px; margin-bottom: 6px; word-break: break-word; line-height: 1.3; }
    .product-price { font-size: 14px; color: #111827; margin: 5px 0; font-weight: 600; }
    .product-actions {
      display: flex;
      gap: 5px;
      margin-top: 8px;
      align-items: center;
    }
    .qty-input {
      width: 55px;
      padding: 5px;
      text-align: center;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-weight: 600;
      font-size: 12px;
    }
    .add-btn {
      padding: 5px 10px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
      transition: background 0.2s;
      font-weight: 600;
      flex: 1;
    }
    .add-btn:hover { background: #059669; }
    .product-channels { margin-top: 5px; font-size: 10px; color: #6b7280; }
    .product-id { color: #6b7280; font-size: 10px; margin-bottom: 2px; }

    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
    }
    .empty-state i { font-size: 36px; margin-bottom: 10px; color: #cbd5e1; }

    /* 加载指示器 */
    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
    }
    .loading-spinner {
      display: inline-block;
      width: 32px;
      height: 32px;
      border: 3px solid #f3f4f6;
      border-left: 3px solid #10b981;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 选品清单模态框 */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 14px;
    }
    .modal-content {
      background: white;
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 16px 32px rgba(0,0,0,0.15);
    }
    .modal-header {
      padding: 14px 18px;
      background: linear-gradient(135deg, #0ea5e9, #3b82f6);
      color: white;
      font-weight: 600;
      font-size: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-actions {
      display: flex;
      gap: 8px;
      padding: 10px 18px;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
    }
    .modal-actions button {
      padding: 5px 10px;
      font-size: 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    .clear-btn {
      background: #fee2e2;
      color: #dc2626;
    }
    .clear-btn:hover {
      background: #fecaca;
    }
    .batch-btn {
      background: #fef3c7;
      color: #d97706;
    }
    .batch-btn:hover {
      background: #fde68a;
    }
    .modal-body {
      padding: 0;
      overflow-y: auto;
      flex: 1;
    }
    .cart-items-container {
      padding: 0 18px 18px;
    }
    .cart-item {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 40px;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid #f1f5f9;
      align-items: center;
    }
    .cart-item:last-child { border: none; }
    .cart-item-header {
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 8px;
      position: sticky;
      top: 0;
      background: white;
      z-index: 1;
    }
    .cart-item input {
      width: 55px;
      padding: 5px;
      text-align: center;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-weight: 600;
      font-size: 12px;
    }
    .remove-btn {
      background: #fee2e2;
      color: #dc2626;
      border: none;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      font-size: 11px;
    }
    .remove-btn:hover {
      background: #fecaca;
    }
    .cart-item-name {
      font-weight: 600;
      margin-bottom: 3px;
      font-size: 13px;
    }
    .cart-item-details {
      font-size: 11px;
      color: #6b7280;
    }
    .cart-item-price {
      font-weight: 600;
      color: #059669;
      font-size: 13px;
    }
    .cart-item-total {
      font-weight: 600;
      color: #1e293b;
      font-size: 13px;
    }

    /* 底部统计 */
    .cart-footer {
      padding: 14px 18px;
      background: #f8fafc;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 14px;
    }
    .cart-total {
      color: #1e293b;
    }
    .cart-count {
      color: #64748b;
      font-size: 12px;
    }

    /* 结果统计 */
    .results-summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      padding: 0 4px;
      font-size: 13px;
      color: #64748b;
    }
    .results-count {
      font-weight: 600;
      color: #1e293b;
    }
    .clear-filters {
      background: none;
      border: none;
      color: #3b82f6;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .clear-filters:hover {
      color: #1d4ed8;
    }

    /* 筛选区折叠按钮 */
    .filter-toggle {
      display: none;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 7px 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 8px;
      width: 100%;
      justify-content: center;
      align-items: center;
      gap: 5px;
      transition: background 0.2s;
    }
    .filter-toggle:hover {
      background: #2563eb;
    }

    /* 返回顶部按钮 */
    .back-to-top {
      position: fixed;
      bottom: 16px;
      right: 16px;
      width: 46px;
      height: 46px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 3px 10px rgba(59, 130, 246, 0.3);
      transition: all 0.3s ease;
      opacity: 0;
      visibility: hidden;
      z-index: 99;
      /* 添加硬件加速优化 */
      transform: translateZ(0);
      backface-visibility: hidden;
    }
    .back-to-top.visible {
      opacity: 1;
      visibility: visible;
    }
    .back-to-top:hover {
      background: #2563eb;
      transform: translateY(-2px);
    }

    /* 客户信息模态框 */
    .customer-info-form {
      padding: 18px;
    }
    .form-group {
      margin-bottom: 14px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #374151;
    }
    .form-group input {
      width: 100%;
      padding: 9px;
      border: 1px solid #d1d5db;
      border-radius: 5px;
      font-size: 13px;
    }
    .form-group input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }
    .form-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 18px;
    }
    .form-actions button {
      padding: 9px 18px;
      border: none;
      border-radius: 5px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .cancel-btn {
      background: #f3f4f6;
      color: #374151;
    }
    .cancel-btn:hover {
      background: #e5e7eb;
    }
    .confirm-btn {
      background: #10b981;
      color: white;
    }
    .confirm-btn:hover {
      background: #059669;
    }

    /* 移动端优化 - 解决多选控件超出问题 */
    @media (max-width: 768px) {
      .filter-toggle {
        display: flex;
      }
      
      .filters.collapsed {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        overflow: hidden;
        margin-bottom: 0;
        /* 优化动画性能 */
        transition: max-height 0.3s ease, padding 0.3s ease, margin 0.3s ease;
      }
      
      /* 重新设计移动端筛选布局 - 更紧凑 */
      .filter-row { 
        flex-direction: column; 
        gap: 4px; /* 减少间距 */
        margin-bottom: 4px; /* 减少底部间距 */
      }
      
      .filter-group, .filter-group-wide, .filter-group-compact, .search-group { 
        min-width: auto; 
        margin-bottom: 0;
      }
      
      .search-group {
        order: -1;
      }
      
      /* 进一步减少筛选区整体内边距 */
      .filters {
        padding: 8px 10px; /* 减少内边距 */
      }
      
      /* 价格区间水平排列 */
      .price-range-row {
        display: flex;
        gap: 4px; /* 减少间距 */
      }
      
      .price-range-row .filter-group-compact {
        flex: 1;
      }
      
      /* 类目筛选水平排列 */
      .category-row {
        display: flex;
        gap: 4px; /* 减少间距 */
      }
      
      .category-row .filter-group-compact {
        flex: 1;
      }
      
      /* 多选控件改为换行显示 - 解决显示不全问题 */
      .multi-select {
        flex-wrap: wrap; /* 改为换行显示 */
        overflow-y: auto; /* 垂直滚动 */
        max-height: 60px; /* 减少高度使控件更紧凑 */
        padding: 4px 5px; /* 减少内边距 */
        white-space: normal; /* 允许换行 */
        -webkit-overflow-scrolling: touch;
        /* 添加滚动条样式 */
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f1f5f9;
      }
      
      /* 自定义滚动条样式 */
      .multi-select::-webkit-scrollbar {
        width: 6px;
      }
      
      .multi-select::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
      }
      
      .multi-select::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
      
      .multi-select::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
      
      .multi-select label {
        flex-shrink: 0;
        padding: 2px 5px; /* 减少标签内边距 */
        background: white;
        border-radius: 3px;
        border: 1px solid #e5e7eb;
        font-size: 9px; /* 进一步减小字体 */
        /* 确保标签在移动端也能正常显示 */
        min-width: auto;
        margin: 1px; /* 减少外边距 */
      }
      
      /* 筛选条件指示器优化 */
      .filter-indicators {
        max-height: 60px; /* 减少高度 */
        overflow-y: auto;
        gap: 4px; /* 减少间距 */
        padding-top: 6px;
        margin-top: 6px; /* 减少顶部间距 */
      }
      
      .filter-tag {
        font-size: 9px; /* 进一步减小字体 */
        padding: 2px 5px; /* 减少内边距 */
      }
      
      /* 其他原有样式 */
      .cart-summary { 
        flex-direction: column; 
        align-items: stretch; 
        padding: 8px 12px; /* 减少内边距 */
      }
      
      .cart-actions {
        display: flex;
        gap: 4px; /* 减少间距 */
      }
      
      .cart-actions button {
        flex: 1;
        padding: 5px 8px; /* 减少内边距 */
        font-size: 10px; /* 进一步减小字体 */
      }
      
      .cart-item { grid-template-columns: 1fr 1fr 1fr 40px; }
      .cart-item-header { grid-template-columns: 1fr 1fr 1fr 40px; }
      .product-actions { flex-direction: column; align-items: stretch; }
      .add-btn { width: 100%; }
      .modal-content { width: 95%; }
      .cart-footer { flex-direction: column; gap: 6px; align-items: flex-start; }
      .results-summary { flex-direction: column; align-items: flex-start; gap: 4px; }
      
      /* 优化筛选区标题 */
      .filter-group label {
        font-size: 10px; /* 进一步减小字体 */
        margin-bottom: 2px; /* 减少底部间距 */
      }
      
      /* 输入框和选择框优化 */
      select, input {
        padding: 4px 5px; /* 减少内边距 */
        font-size: 10px; /* 进一步减小字体 */
      }
      
      /* 进一步减少移动端整体间距 */
      .container {
        padding: 0 10px; /* 减少容器内边距 */
      }
      
      .sticky-header {
        padding: 10px 0 0; /* 减少内边距 */
        margin: -10px 0 10px; /* 调整边距 */
      }
      
      header {
        margin-bottom: 10px; /* 减少底部间距 */
      }
      
      h1 {
        font-size: 1.5rem; /* 进一步减小标题字体 */
      }
      
      .subtitle {
        font-size: 0.8rem; /* 进一步减小副标题字体 */
      }
      
      .filters {
        padding: 8px 10px; /* 减少内边距 */
        margin-bottom: 10px; /* 减少底部间距 */
      }
      
      .cart-summary {
        margin-bottom: 10px; /* 减少底部间距 */
      }
      
      .products {
        gap: 10px; /* 减少间距 */
        /* 优化网格布局性能 */
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }
      
      /* 优化产品卡片在移动端的显示 */
      .product-card {
        /* 减少移动端的悬停效果 */
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      
      .product-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      }
      
      .product-img-container {
        height: 130px; /* 在移动端进一步减小图片容器高度 */
      }
      
      .product-body {
        padding: 8px; /* 减少内边距 */
      }
      
      .product-name {
        font-size: 12px; /* 进一步减小字体 */
      }
      
      .product-price {
        font-size: 12px; /* 进一步减小字体 */
      }
      
      /* 优化滚动性能 */
      .sticky-header {
        /* 添加硬件加速 */
        transform: translateZ(0);
        backface-visibility: hidden;
        perspective: 1000px;
      }
      
      /* 减少背景轮播的动画效果以改善性能 */
      .bg-slideshow .slide {
        transition: opacity 2s ease-in-out; /* 减慢过渡速度 */
      }
    }

    /* 进一步优化小屏幕设备 */
    @media (max-width: 480px) {
      .products {
        grid-template-columns: repeat(2, 1fr); /* 在小屏幕上固定为2列 */
        gap: 8px; /* 进一步减少间距 */
      }
      
      .product-img-container {
        height: 110px; /* 进一步减小图片容器高度 */
      }
      
      .product-body {
        padding: 6px; /* 进一步减少内边距 */
      }
      
      .product-name {
        font-size: 11px; /* 进一步减小字体 */
      }
      
      .product-price {
        font-size: 11px; /* 进一步减小字体 */
      }
      
      .multi-select {
        max-height: 55px; /* 进一步限制多选控件高度 */
      }
      
      /* 进一步减少筛选区间距 */
      .filters {
        padding: 6px 8px; /* 进一步减少内边距 */
      }
    }

    /* 防止页面抖动 - 添加滚动条占位 */
    html {
      scrollbar-gutter: stable;
    }
  </style>
</head>
<body>
  <!-- 背景轮播容器 -->
  <div class="bg-slideshow" id="bgSlideshow">
    <!-- 背景图片将通过JavaScript动态添加 -->
  </div>
  
  <!-- 背景遮罩 -->
  <div class="bg-overlay"></div>

  <div class="container">
    <!-- 置顶头部区域 - 更紧凑 -->
    <div class="sticky-header">
      <header>
        <h1><i class="fas fa-boxes"></i> 产品报价选品表</h1>
        <p class="subtitle">专业选品工具，支持多级分类筛选与批量导出</p>
      </header>

      <div class="cart-summary">
        <div class="cart-info">
          <i class="fas fa-shopping-cart"></i> 已选 <span id="selectedCount">0</span> 款商品，共 <span id="totalQuantity">0</span> 件，总价：<span id="totalPrice">¥0.00</span>
        </div>
        <div class="cart-actions">
          <button id="viewCart"><i class="fas fa-list"></i> 查看选品清单</button>
          <button id="exportSelected"><i class="fas fa-file-export"></i> 导出选品</button>
        </div>
      </div>

      <!-- 筛选区折叠按钮（移动端） -->
      <button class="filter-toggle" id="filterToggle">
        <i class="fas fa-filter"></i> 筛选条件
        <i class="fas fa-chevron-down" id="filterToggleIcon"></i>
      </button>

      <!-- 优化后的筛选区域 - 更紧凑布局 -->
      <div class="filters" id="filtersContainer">
        <!-- 第一行：搜索、价格、排序和类目筛选 -->
        <div class="filter-row">
          <div class="search-group">
            <label><i class="fas fa-search"></i> 智能搜索</label>
            <input type="text" id="universalSearchInput" placeholder="搜索货品名称、规格、品牌、ID或条码...">
          </div>
          <div class="filter-group-compact">
            <label><i class="fas fa-tag"></i> 最低价</label>
            <input type="number" id="minPrice" placeholder="¥ 0">
          </div>
          <div class="filter-group-compact">
            <label><i class="fas fa-tag"></i> 最高价</label>
            <input type="number" id="maxPrice" placeholder="¥ 9999">
          </div>
          <div class="filter-group-compact">
            <label><i class="fas fa-sort"></i> 排序</label>
            <select id="sortOrder">
              <option value="">默认</option>
              <option value="asc">价格从低到高</option>
              <option value="desc">价格从高到低</option>
            </select>
          </div>
          <div class="filter-group-compact">
            <label><i class="fas fa-layer-group"></i> 一级类目</label>
            <select id="cat1Filter">
              <option value="">全部</option>
            </select>
          </div>
          <div class="filter-group-compact">
            <label>二级类目</label>
            <select id="cat2Filter">
              <option value="">全部</option>
            </select>
          </div>
          <div class="filter-group-compact">
            <label>三级类目</label>
            <select id="cat3Filter">
              <option value="">全部</option>
            </select>
          </div>
        </div>

        <!-- 第二行：品牌和渠道筛选 -->
        <div class="filter-row">
          <div class="filter-group-wide">
            <label><i class="fas fa-tags"></i> 品牌（多选）</label>
            <div class="multi-select" id="brandFilters"></div>
          </div>
          <div class="filter-group-wide">
            <label><i class="fas fa-store"></i> 开放渠道（多选）</label>
            <div class="multi-select" id="channelFilters"></div>
          </div>
        </div>
        
        <!-- 筛选条件指示器 -->
        <div class="filter-indicators" id="filterIndicators">
          <!-- 动态生成的筛选条件标签 -->
        </div>
      </div>

      <!-- 结果统计 -->
      <div class="results-summary">
        <div class="results-info">
          显示 <span class="results-count" id="resultsCount">0</span> 个商品
        </div>
        <button class="clear-filters" id="clearFilters">
          <i class="fas fa-times"></i> 清除所有筛选条件
        </button>
      </div>
    </div>

    <div class="loading" id="loadingIndicator">
      <div class="loading-spinner"></div>
      <div>正在加载产品数据...</div>
    </div>
    
    <!-- 文件选择区域 -->
    <div id="fileInputContainer" style="text-align: center; margin: 16px 0; display: none;">
      <label for="csvFileInput" style="display: inline-block; padding: 10px 20px; background: #3b82f6; color: white; border-radius: 5px; cursor: pointer; font-weight: 600;">
        <i class="fas fa-file-csv"></i> 选择CSV数据文件
      </label>
      <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
      <p style="margin-top: 8px; color: #64748b; font-size: 13px;">请选择与HTML文件同文件夹下的data.csv文件</p>
    </div>
    
    <div class="products" id="productList"></div>
  </div>

  <!-- 返回顶部按钮 -->
  <button class="back-to-top" id="backToTop">
    <i class="fas fa-arrow-up"></i>
  </button>

  <!-- 选品清单模态框 -->
  <div class="modal" id="cartModal">
    <div class="modal-content">
      <div class="modal-header">
        <span><i class="fas fa-clipboard-list"></i> 已选商品清单</span>
        <button id="closeModal"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-actions">
        <button class="clear-btn" id="clearAll"><i class="fas fa-trash"></i> 清空全部</button>
        <button class="batch-btn" id="batchSet"><i class="fas fa-edit"></i> 批量设为</button>
      </div>
      <div class="modal-body">
        <div class="cart-items-container" id="cartItems"></div>
      </div>
      <div class="cart-footer">
        <div class="cart-count">共 <span id="modalSelectedCount">0</span> 款商品，<span id="modalTotalQuantity">0</span> 件</div>
        <div class="cart-total">总计: <span id="modalTotalPrice">¥0.00</span></div>
      </div>
    </div>
  </div>

  <!-- 客户信息模态框 -->
  <div class="modal" id="customerInfoModal">
    <div class="modal-content">
      <div class="modal-header">
        <span><i class="fas fa-user"></i> 客户信息</span>
        <button id="closeCustomerModal"><i class="fas fa-times"></i></button>
      </div>
      <div class="customer-info-form">
        <div class="form-group">
          <label for="customerName">姓名 <span style="color: #ef4444;">*</span></label>
          <input type="text" id="customerName" placeholder="请输入您的姓名">
        </div>
        <div class="form-group">
          <label for="customerPhone">手机号 <span style="color: #ef4444;">*</span></label>
          <input type="tel" id="customerPhone" placeholder="请输入您的手机号">
        </div>
        <div class="form-actions">
          <button class="cancel-btn" id="cancelCustomerInfo">取消</button>
          <button class="confirm-btn" id="confirmCustomerInfo">确认导出</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 背景轮播配置
    const BACKGROUND_IMAGES = [
      'https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80',
      'https://images.unsplash.com/photo-1556742044-3c52d6e88c62?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80',
      'https://images.unsplash.com/photo-1556740772-0a674ca8c8ad?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80',
      'https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80',
      'https://images.unsplash.com/photo-1556742111-a301076d9d4c?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80'
    ];
    
    let bgCurrentIndex = 0;
    let bgInterval;
    const BG_CHANGE_INTERVAL = 5000; // 5秒切换一次

    // 初始化背景轮播
    function initBackgroundSlideshow() {
      const slideshowContainer = document.getElementById('bgSlideshow');
      
      // 创建背景图片元素
      BACKGROUND_IMAGES.forEach((url, index) => {
        const slide = document.createElement('div');
        slide.className = `slide ${index === 0 ? 'active' : ''}`;
        slide.style.backgroundImage = `url('${url}')`;
        slideshowContainer.appendChild(slide);
      });
      
      // 开始自动轮播
      startBackgroundSlideshow();
    }
    
    // 开始背景轮播
    function startBackgroundSlideshow() {
      bgInterval = setInterval(nextBackgroundSlide, BG_CHANGE_INTERVAL);
    }
    
    // 切换到下一张背景
    function nextBackgroundSlide() {
      goToBackgroundSlide((bgCurrentIndex + 1) % BACKGROUND_IMAGES.length);
    }
    
    // 跳转到指定背景
    function goToBackgroundSlide(index) {
      const slides = document.querySelectorAll('.bg-slideshow .slide');
      
      // 移除当前活动状态
      slides[bgCurrentIndex].classList.remove('active');
      
      // 设置新的活动状态
      bgCurrentIndex = index;
      slides[bgCurrentIndex].classList.add('active');
    }

    // 移除Google Sheets相关代码，改为从本地CSV文件读取
    let allProducts = [];
    let filteredProducts = [];
    let selectedProducts = new Map(); // Map<id, { product, quantity }>
    let filterTimeout = null;

    // 默认图片SVG
    const DEFAULT_IMAGE_SVG = `
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="3" y="3" width="18" height="18" rx="2" stroke="#9ca3af" stroke-width="2"/>
        <circle cx="8.5" cy="8.5" r="1.5" stroke="#9ca3af" stroke-width="2"/>
        <path d="M21 15L16 10L5 21" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    `;

    // 优化CSV解析
    function parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim() !== '');
      if (lines.length === 0) return [];
      
      const headers = lines[0].split(',').map(h => h.trim());
      const data = [];
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;
        
        let current = '';
        let inQuotes = false;
        let fields = [];
        
        for (let j = 0; j < line.length; j++) {
          const char = line[j];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            fields.push(current);
            current = '';
          } else {
            current += char;
          }
        }
        fields.push(current);
        
        if (fields.length === headers.length) {
          const row = {};
          headers.forEach((header, idx) => {
            row[header] = fields[idx] || '';
          });
          data.push(row);
        }
      }
      return data;
    }

    // 为数据添加ID和条码（如果不存在）
    function enhanceProductData(products) {
      return products.map((p, index) => {
        // 如果数据中没有货品ID，使用索引生成一个
        if (!p['货品ID']) {
          p['货品ID'] = `PID${String(index+1).padStart(4, '0')}`;
        }
        
        // 如果数据中没有货品条码，生成一个模拟条码
        if (!p['货品条码']) {
          // 使用EAN-13格式生成模拟条码
          const base = '200000000000';
          p['货品条码'] = (parseInt(base) + index).toString();
        }
        
        return p;
      });
    }

    function getUniqueId(p) {
      return `${p['货品名称']}-${p['货品规格']}`;
    }

    function formatPrice(num) {
      return isNaN(num) ? '¥--' : `¥${parseFloat(num).toFixed(2)}`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // 智能搜索实现 - 在所有相关字段中搜索
    function smartSearch(product, searchTerm) {
      if (!searchTerm) return true;
      
      const searchLower = searchTerm.toLowerCase();
      
      // 检查所有相关字段
      const fieldsToSearch = [
        '货品名称',
        '货品规格', 
        '品牌',
        '货品ID',
        '货品条码',
        '一级类目',
        '二级类目',
        '三级类目'
      ];
      
      // 检查是否有任何字段包含搜索词
      for (const field of fieldsToSearch) {
        if (product[field] && product[field].toLowerCase().includes(searchLower)) {
          return true;
        }
      }
      
      return false;
    }

    // 验证手机号格式
    function validatePhone(phone) {
      const phoneRegex = /^1[3-9]\d{9}$/;
      return phoneRegex.test(phone);
    }

    // 加载状态
    function loadState() {
      const saved = localStorage.getItem('productSelectorState_v8');
      if (saved) {
        try {
          const state = JSON.parse(saved);
          document.getElementById('universalSearchInput').value = state.search || '';
          document.getElementById('minPrice').value = state.minPrice || '';
          document.getElementById('maxPrice').value = state.maxPrice || '';
          document.getElementById('sortOrder').value = state.sortOrder || '';

          window.tempSavedBrands = state.selectedBrands || [];
          window.tempSavedChannels = state.selectedChannels || [];

          if (state.selectedProducts) {
            selectedProducts = new Map(Object.entries(state.selectedProducts));
          }
          
          // 恢复筛选区折叠状态
          if (state.filtersCollapsed && window.innerWidth <= 768) {
            document.getElementById('filtersContainer').classList.add('collapsed');
            document.getElementById('filterToggleIcon').className = 'fas fa-chevron-down';
          }
        } catch (e) {
          console.warn('Load state failed', e);
        }
      }
    }

    // 保存状态
    function saveState() {
      const state = {
        search: document.getElementById('universalSearchInput').value,
        minPrice: document.getElementById('minPrice').value,
        maxPrice: document.getElementById('maxPrice').value,
        sortOrder: document.getElementById('sortOrder').value,
        selectedBrands: Array.from(document.querySelectorAll('#brandFilters input:checked')).map(el => el.value),
        selectedChannels: Array.from(document.querySelectorAll('#channelFilters input:checked')).map(el => el.value),
        selectedProducts: Object.fromEntries(selectedProducts),
        filtersCollapsed: document.getElementById('filtersContainer').classList.contains('collapsed')
      };
      localStorage.setItem('productSelectorState_v8', JSON.stringify(state));
    }

    // 渲染多选控件
    function renderMultiSelect(containerId, items, savedSelection = []) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      [...new Set(items)].filter(i => i).sort().forEach(item => {
        const label = document.createElement('label');
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.value = item;
        if (savedSelection.includes(item)) input.checked = true;
        input.addEventListener('change', applyFilters);
        label.appendChild(input);
        label.appendChild(document.createTextNode(item));
        container.appendChild(label);
      });
    }

    // 渲染下拉菜单
    function renderDropdown(id, options) {
      const select = document.getElementById(id);
      const currentValue = select.value;
      select.innerHTML = '<option value="">全部</option>';
      [...new Set(options)].filter(o => o).sort().forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        if (opt === currentValue) option.selected = true;
        select.appendChild(option);
      });
    }

    // 更新购物车摘要
    function updateCartSummary() {
      let totalCount = 0;
      let totalQuantity = 0;
      let totalPrice = 0;

      for (const [id, { product, quantity }] of selectedProducts) {
        totalCount++;
        totalQuantity += quantity;
        totalPrice += parseFloat(product['单价 (元)']) * quantity;
      }

      document.getElementById('selectedCount').textContent = totalCount;
      document.getElementById('totalQuantity').textContent = totalQuantity;
      document.getElementById('totalPrice').textContent = `¥${totalPrice.toFixed(2)}`;
      
      // 更新模态框中的统计
      document.getElementById('modalSelectedCount').textContent = totalCount;
      document.getElementById('modalTotalQuantity').textContent = totalQuantity;
      document.getElementById('modalTotalPrice').textContent = `¥${totalPrice.toFixed(2)}`;
    }

    // 渲染筛选条件指示器
    function renderFilterIndicators() {
      const container = document.getElementById('filterIndicators');
      container.innerHTML = '';
      
      const search = document.getElementById('universalSearchInput').value;
      if (search) {
        const tag = document.createElement('div');
        tag.className = 'filter-tag';
        tag.innerHTML = `搜索: "${search}" <span class="remove" data-type="search"><i class="fas fa-times"></i></span>`;
        container.appendChild(tag);
      }
      
      const minPrice = document.getElementById('minPrice').value;
      if (minPrice) {
        const tag = document.createElement('div');
        tag.className = 'filter-tag';
        tag.innerHTML = `最低价: ¥${minPrice} <span class="remove" data-type="minPrice"><i class="fas fa-times"></i></span>`;
        container.appendChild(tag);
      }
      
      const maxPrice = document.getElementById('maxPrice').value;
      if (maxPrice) {
        const tag = document.createElement('div');
        tag.className = 'filter-tag';
        tag.innerHTML = `最高价: ¥${maxPrice} <span class="remove" data-type="maxPrice"><i class="fas fa-times"></i></span>`;
        container.appendChild(tag);
      }
      
      const cat1 = document.getElementById('cat1Filter').value;
      if (cat1) {
        const tag = document.createElement('div');
        tag.className = 'filter-tag';
        tag.innerHTML = `一级类目: ${cat1} <span class="remove" data-type="cat1"><i class="fas fa-times"></i></span>`;
        container.appendChild(tag);
      }
      
      const cat2 = document.getElementById('cat2Filter').value;
      if (cat2) {
        const tag = document.createElement('div');
        tag.className = 'filter-tag';
        tag.innerHTML = `二级类目: ${cat2} <span class="remove" data-type="cat2"><i class="fas fa-times"></i></span>`;
        container.appendChild(tag);
      }
      
      const cat3 = document.getElementById('cat3Filter').value;
      if (cat3) {
        const tag = document.createElement('div');
        tag.className = 'filter-tag';
        tag.innerHTML = `三级类目: ${cat3} <span class="remove" data-type="cat3"><i class="fas fa-times"></i></span>`;
        container.appendChild(tag);
      }
      
      const selectedBrands = Array.from(document.querySelectorAll('#brandFilters input:checked')).map(el => el.value);
      selectedBrands.forEach(brand => {
        const tag = document.createElement('div');
        tag.className = 'filter-tag';
        tag.innerHTML = `品牌: ${brand} <span class="remove" data-type="brand" data-value="${brand}"><i class="fas fa-times"></i></span>`;
        container.appendChild(tag);
      });
      
      const selectedChannels = Array.from(document.querySelectorAll('#channelFilters input:checked')).map(el => el.value);
      selectedChannels.forEach(channel => {
        const tag = document.createElement('div');
        tag.className = 'filter-tag';
        tag.innerHTML = `渠道: ${channel} <span class="remove" data-type="channel" data-value="${channel}"><i class="fas fa-times"></i></span>`;
        container.appendChild(tag);
      });
      
      // 添加事件监听器
      container.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove') || e.target.closest('.remove')) {
          const removeEl = e.target.classList.contains('remove') ? e.target : e.target.closest('.remove');
          const type = removeEl.dataset.type;
          const value = removeEl.dataset.value;
          
          switch(type) {
            case 'search':
              document.getElementById('universalSearchInput').value = '';
              break;
            case 'minPrice':
              document.getElementById('minPrice').value = '';
              break;
            case 'maxPrice':
              document.getElementById('maxPrice').value = '';
              break;
            case 'cat1':
              document.getElementById('cat1Filter').value = '';
              break;
            case 'cat2':
              document.getElementById('cat2Filter').value = '';
              break;
            case 'cat3':
              document.getElementById('cat3Filter').value = '';
              break;
            case 'brand':
              const brandCheckbox = document.querySelector(`#brandFilters input[value="${value}"]`);
              if (brandCheckbox) brandCheckbox.checked = false;
              break;
            case 'channel':
              const channelCheckbox = document.querySelector(`#channelFilters input[value="${value}"]`);
              if (channelCheckbox) channelCheckbox.checked = false;
              break;
          }
          
          applyFilters();
        }
      });
    }

    // 渲染购物车项目
    function renderCartItems() {
      const container = document.getElementById('cartItems');
      if (selectedProducts.size === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-shopping-cart"></i><h3>暂无选品</h3><p>请先添加商品到选品清单</p></div>';
        return;
      }

      let html = `
        <div class="cart-item cart-item-header">
          <div>商品信息</div>
          <div>单价</div>
          <div>数量</div>
          <div>小计</div>
          <div></div>
        </div>
      `;

      for (const [id, { product, quantity }] of selectedProducts) {
        const unitPrice = parseFloat(product['单价 (元)']);
        const subtotal = unitPrice * quantity;
        html += `
          <div class="cart-item" data-id="${escapeHtml(id)}">
            <div>
              <div class="cart-item-name">${escapeHtml(product['品牌'])} - ${escapeHtml(product['货品名称'])}</div>
              <div class="cart-item-details">${escapeHtml(product['货品规格'])}</div>
            </div>
            <div class="cart-item-price">${formatPrice(unitPrice)}</div>
            <div><input type="number" min="1" value="${quantity}" data-id="${escapeHtml(id)}" class="cart-qty-input"></div>
            <div class="cart-item-total">${formatPrice(subtotal)}</div>
            <div><button class="remove-btn" data-id="${escapeHtml(id)}"><i class="fas fa-times"></i></button></div>
          </div>
        `;
      }

      container.innerHTML = html;

      // 使用事件委托处理购物车数量变化
      container.addEventListener('change', function(e) {
        if (e.target.classList.contains('cart-qty-input')) {
          const id = e.target.dataset.id;
          const qty = parseInt(e.target.value) || 1;
          const entry = selectedProducts.get(id);
          if (entry) {
            entry.quantity = qty;
            selectedProducts.set(id, entry);
            updateCartSummary();
            saveState();
            renderCartItems(); // 重新渲染以更新小计
          }
        }
      });

      // 使用事件委托处理删除按钮
      container.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-btn') || e.target.closest('.remove-btn')) {
          const id = e.target.dataset.id || e.target.closest('.remove-btn').dataset.id;
          selectedProducts.delete(id);
          updateCartSummary();
          renderCartItems();
          saveState();
        }
      });
    }

    // 渲染产品列表
    function renderProducts(products) {
      filteredProducts = products;
      const container = document.getElementById('productList');
      
      // 更新结果统计
      document.getElementById('resultsCount').textContent = products.length;
      
      if (products.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><h3>未找到匹配的商品</h3><p>请尝试调整筛选条件或搜索关键词</p></div>';
        return;
      }

      // 使用文档片段批量插入
      const fragment = document.createDocumentFragment();
      
      products.forEach(p => {
        const id = getUniqueId(p);
        const existingQty = selectedProducts.has(id) ? selectedProducts.get(id).quantity : 0;
        const channels = p['开放渠道'] ? p['开放渠道'].split(',').map(c => c.trim()).join('、') : '';

        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
          <div class="product-img-container">
            ${p['图片链接'] && p['图片链接'].trim() !== '' ? 
              `<img src="${escapeHtml(p['图片链接'])}" alt="${escapeHtml(p['货品名称'])}" class="product-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"> 
               <div class="no-image" style="display:none">${DEFAULT_IMAGE_SVG}<span>暂无图片</span></div>` : 
              `<div class="no-image">${DEFAULT_IMAGE_SVG}<span>暂无图片</span></div>`
            }
          </div>
          <div class="product-body">
            <div class="product-brand">${escapeHtml(p['品牌'])}</div>
            <div class="product-name">${escapeHtml(p['货品名称'])}</div>
            <div class="product-spec">${escapeHtml(p['货品规格'])}</div>
            <div class="product-id">ID: ${escapeHtml(p['货品ID'])} | 条码: ${escapeHtml(p['货品条码'])}</div>
            <div class="product-price">${formatPrice(p['单价 (元)'])} / ${escapeHtml(p['销售单位'])}</div>
            <div class="product-actions">
              <input type="number" min="1" value="1" class="qty-input" data-id="${escapeHtml(id)}">
              <button class="add-btn" data-id="${escapeHtml(id)}">
                <i class="fas fa-cart-plus"></i> ${existingQty > 0 ? `再添 ${existingQty} → ${existingQty + 1}` : '加入选品'}
              </button>
            </div>
            <div class="product-channels">渠道：${escapeHtml(channels)}</div>
          </div>
        `;
        fragment.appendChild(card);
      });

      container.innerHTML = '';
      container.appendChild(fragment);
    }

    // 应用筛选条件
    function applyFilters() {
      // 使用防抖减少频繁筛选
      clearTimeout(filterTimeout);
      filterTimeout = setTimeout(() => {
        const search = document.getElementById('universalSearchInput').value;
        const minPrice = parseFloat(document.getElementById('minPrice').value) || -Infinity;
        const maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;
        const sortOrder = document.getElementById('sortOrder').value;

        const selectedBrands = Array.from(document.querySelectorAll('#brandFilters input:checked')).map(el => el.value);
        const selectedChannels = Array.from(document.querySelectorAll('#channelFilters input:checked')).map(el => el.value);
        const cat1 = document.getElementById('cat1Filter').value;
        const cat2 = document.getElementById('cat2Filter').value;
        const cat3 = document.getElementById('cat3Filter').value;

        let filtered = allProducts.filter(p => {
          // 智能搜索 - 在所有相关字段中查找
          if (search && !smartSearch(p, search)) {
            return false;
          }
          
          const price = parseFloat(p['单价 (元)']);
          if (price < minPrice || price > maxPrice) return false;
          if (selectedBrands.length > 0 && !selectedBrands.includes(p['品牌'])) return false;
          if (cat1 && p['一级类目'] !== cat1) return false;
          if (cat2 && p['二级类目'] !== cat2) return false;
          if (cat3 && p['三级类目'] !== cat3) return false;
          if (selectedChannels.length > 0) {
            const itemChannels = p['开放渠道'] ? p['开放渠道'].split(',').map(c => c.trim()) : [];
            if (!selectedChannels.some(ch => itemChannels.includes(ch))) return false;
          }
          return true;
        });

        if (sortOrder === 'asc') {
          filtered.sort((a, b) => parseFloat(a['单价 (元)']) - parseFloat(b['单价 (元)']));
        } else if (sortOrder === 'desc') {
          filtered.sort((a, b) => parseFloat(b['单价 (元)']) - parseFloat(a['单价 (元)']));
        }

        renderProducts(filtered);
        renderFilterIndicators();
        saveState();
      }, 300); // 300ms防抖延迟
    }

    // 更新分类筛选器
    function updateCategoryFilters() {
      const selectedBrands = Array.from(document.querySelectorAll('#brandFilters input:checked')).map(el => el.value);

      const cat1Options = allProducts
        .filter(p => selectedBrands.length === 0 || selectedBrands.includes(p['品牌']))
        .map(p => p['一级类目']);
      renderDropdown('cat1Filter', cat1Options);

      const cat2Options = allProducts
        .filter(p => (selectedBrands.length === 0 || selectedBrands.includes(p['品牌'])) && 
                    (!document.getElementById('cat1Filter').value || p['一级类目'] === document.getElementById('cat1Filter').value))
        .map(p => p['二级类目']);
      renderDropdown('cat2Filter', cat2Options);

      const cat3Options = allProducts
        .filter(p => (selectedBrands.length === 0 || selectedBrands.includes(p['品牌'])) &&
                    (!document.getElementById('cat1Filter').value || p['一级类目'] === document.getElementById('cat1Filter').value) &&
                    (!document.getElementById('cat2Filter').value || p['二级类目'] === document.getElementById('cat2Filter').value))
        .map(p => p['三级类目']);
      renderDropdown('cat3Filter', cat3Options);
    }

    // 导出选品 - 解决乱码问题
    function exportSelectedWithCustomerInfo(name, phone) {
      if (selectedProducts.size === 0) {
        alert('请先选择商品');
        return;
      }
      
      const data = Array.from(selectedProducts.values()).map(({ product, quantity }) => ({
        '品牌': product['品牌'] || '',
        '货品名称': product['货品名称'] || '',
        '货品规格': product['货品规格'] || '',
        '单价 (元)': product['单价 (元)'] || '',
        '采购数量': quantity,
        '小计': (parseFloat(product['单价 (元)']) * quantity).toFixed(2),
        '销售单位': product['销售单位'] || '',
        '开放渠道': product['开放渠道'] || '',
        '一级类目': product['一级类目'] || '',
        '二级类目': product['二级类目'] || '',
        '三级类目': product['三级类目'] || '',
        '货品ID': product['货品ID'] || '',
        '货品条码': product['货品条码'] || ''
      }));
      
      const headers = ['品牌', '货品名称', '货品规格', '单价 (元)', '采购数量', '小计', '销售单位', '开放渠道', '一级类目', '二级类目', '三级类目', '货品ID', '货品条码'];
      
      // 创建CSV内容
      let csvContent = '\uFEFF'; // 添加BOM解决中文乱码
      
      // 添加客户信息
      csvContent += `客户姓名,${name}\n`;
      csvContent += `客户手机,${phone}\n`;
      csvContent += `导出日期,${new Date().toLocaleDateString()}\n`;
      csvContent += `\n`;
      
      csvContent += headers.join(',') + '\n';
      
      data.forEach(item => {
        const row = headers.map(header => {
          let value = item[header] || '';
          // 处理包含逗号或引号的值
          if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
            value = '"' + value.replace(/"/g, '""') + '"';
          }
          return value;
        });
        csvContent += row.join(',') + '\n';
      });
      
      // 创建并下载文件
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      
      // 使用客户信息生成文件名
      const date = new Date().toISOString().slice(0,10);
      a.download = `选品清单_${name}_${phone}_${date}.csv`;
      
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // 清除所有筛选条件
    function clearAllFilters() {
      document.getElementById('universalSearchInput').value = '';
      document.getElementById('minPrice').value = '';
      document.getElementById('maxPrice').value = '';
      document.getElementById('sortOrder').value = '';
      document.getElementById('cat1Filter').value = '';
      document.getElementById('cat2Filter').value = '';
      document.getElementById('cat3Filter').value = '';
      
      // 清除所有多选框
      document.querySelectorAll('#brandFilters input:checked').forEach(cb => cb.checked = false);
      document.querySelectorAll('#channelFilters input:checked').forEach(cb => cb.checked = false);
      
      applyFilters();
    }

    // 切换筛选区折叠状态
    function toggleFilters() {
      const filtersContainer = document.getElementById('filtersContainer');
      const toggleIcon = document.getElementById('filterToggleIcon');
      
      if (filtersContainer.classList.contains('collapsed')) {
        filtersContainer.classList.remove('collapsed');
        toggleIcon.className = 'fas fa-chevron-up';
      } else {
        filtersContainer.classList.add('collapsed');
        toggleIcon.className = 'fas fa-chevron-down';
      }
      
      saveState();
    }

    // 处理CSV文件读取
    function handleCSVFile(file) {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const csvText = e.target.result;
          allProducts = parseCSV(csvText);
          
          // 增强产品数据（添加ID和条码）
          allProducts = enhanceProductData(allProducts);

          loadState();

          const brands = allProducts.map(p => p['品牌']);
          const channels = allProducts.flatMap(p => p['开放渠道'] ? p['开放渠道'].split(',').map(c => c.trim()) : []);
          renderMultiSelect('brandFilters', brands, window.tempSavedBrands || []);
          renderMultiSelect('channelFilters', channels, window.tempSavedChannels || []);

          updateCategoryFilters();
          applyFilters();
          updateCartSummary();

          // 隐藏加载指示器和文件选择区域
          document.getElementById('loadingIndicator').style.display = 'none';
          document.getElementById('fileInputContainer').style.display = 'none';

        } catch (error) {
          console.error('处理CSV文件失败:', error);
          document.getElementById('loadingIndicator').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>解析CSV文件失败</h3><p>请检查CSV文件格式是否正确</p></div>';
        }
      };
      
      reader.onerror = function() {
        console.error('读取文件失败');
        document.getElementById('loadingIndicator').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>读取文件失败</h3><p>请重新选择文件</p></div>';
      };
      
      reader.readAsText(file, 'UTF-8');
    }

    // 尝试自动加载同目录下的data.csv文件
    function tryAutoLoadCSV() {
      // 尝试通过fetch加载同目录下的data.csv
      fetch('./data.csv')
        .then(response => {
          if (!response.ok) {
            throw new Error('CSV文件不存在或无法访问');
          }
          return response.text();
        })
        .then(csvText => {
          allProducts = parseCSV(csvText);
          allProducts = enhanceProductData(allProducts);
          loadState();

          const brands = allProducts.map(p => p['品牌']);
          const channels = allProducts.flatMap(p => p['开放渠道'] ? p['开放渠道'].split(',').map(c => c.trim()) : []);
          renderMultiSelect('brandFilters', brands, window.tempSavedBrands || []);
          renderMultiSelect('channelFilters', channels, window.tempSavedChannels || []);

          updateCategoryFilters();
          applyFilters();
          updateCartSummary();

          document.getElementById('loadingIndicator').style.display = 'none';
        })
        .catch(error => {
          console.log('自动加载CSV失败，显示文件选择器:', error);
          // 自动加载失败，显示文件选择器
          document.getElementById('loadingIndicator').style.display = 'none';
          document.getElementById('fileInputContainer').style.display = 'block';
        });
    }

    // 初始化应用
    function init() {
      // 初始化背景轮播
      initBackgroundSlideshow();
      
      // 显示加载指示器
      document.getElementById('loadingIndicator').style.display = 'block';
      
      // 尝试自动加载CSV文件
      tryAutoLoadCSV();

      // 绑定文件选择事件
      document.getElementById('csvFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          document.getElementById('loadingIndicator').style.display = 'block';
          document.getElementById('fileInputContainer').style.display = 'none';
          handleCSVFile(file);
        }
      });

      // 绑定筛选事件
      ['universalSearchInput', 'minPrice', 'maxPrice', 'sortOrder'].forEach(id => {
        document.getElementById(id).addEventListener('input', applyFilters);
      });
      document.getElementById('sortOrder').addEventListener('change', applyFilters);
      document.getElementById('cat1Filter').addEventListener('change', () => {
        document.getElementById('cat2Filter').innerHTML = '<option value="">全部</option>';
        document.getElementById('cat3Filter').innerHTML = '<option value="">全部</option>';
        updateCategoryFilters();
        applyFilters();
      });
      document.getElementById('cat2Filter').addEventListener('change', () => {
        document.getElementById('cat3Filter').innerHTML = '<option value="">全部</option>';
        updateCategoryFilters();
        applyFilters();
      });
      document.getElementById('cat3Filter').addEventListener('change', applyFilters);

      // 使用事件委托处理产品卡片事件
      document.getElementById('productList').addEventListener('click', function(e) {
        if (e.target.classList.contains('add-btn') || e.target.closest('.add-btn')) {
          const btn = e.target.classList.contains('add-btn') ? e.target : e.target.closest('.add-btn');
          const id = btn.dataset.id;
          const qtyInput = btn.closest('.product-card').querySelector('.qty-input');
          const qty = parseInt(qtyInput.value) || 1;
          const product = allProducts.find(p => getUniqueId(p) === id);
          
          if (product) {
            // 如果商品已存在，累加数量；否则新增
            if (selectedProducts.has(id)) {
              const existing = selectedProducts.get(id);
              existing.quantity += qty;
              selectedProducts.set(id, existing);
            } else {
              selectedProducts.set(id, { product, quantity: qty });
            }
            
            updateCartSummary();
            saveState();
            
            // 更新按钮文本显示
            const existingQty = selectedProducts.get(id).quantity;
            btn.innerHTML = `<i class="fas fa-cart-plus"></i> ${existingQty > 0 ? `再添 ${existingQty - qty} → ${existingQty}` : '加入选品'}`;
            
            // 重置输入框
            qtyInput.value = 1;
          }
        }
      });

      // 清单相关
      document.getElementById('viewCart').addEventListener('click', () => {
        renderCartItems();
        document.getElementById('cartModal').style.display = 'flex';
      });

      document.getElementById('closeModal').addEventListener('click', () => {
        document.getElementById('cartModal').style.display = 'none';
      });

      document.getElementById('clearAll').addEventListener('click', () => {
        if (confirm('确定清空所有选品？')) {
          selectedProducts.clear();
          updateCartSummary();
          renderCartItems();
          saveState();
          applyFilters(); // 重新渲染产品列表以更新按钮状态
        }
      });

      document.getElementById('batchSet').addEventListener('click', () => {
        const qtyStr = prompt('请输入统一数量（≥1）：', '1');
        if (qtyStr === null) return;
        const qty = parseInt(qtyStr);
        if (isNaN(qty) || qty < 1) {
          alert('请输入有效数量');
          return;
        }
        for (const [id, entry] of selectedProducts) {
          entry.quantity = qty;
          selectedProducts.set(id, entry);
        }
        updateCartSummary();
        renderCartItems();
        saveState();
      });

      // 导出按钮事件 - 打开客户信息模态框
      document.getElementById('exportSelected').addEventListener('click', () => {
        if (selectedProducts.size === 0) {
          alert('请先选择商品');
          return;
        }
        document.getElementById('customerInfoModal').style.display = 'flex';
      });

      // 客户信息模态框事件
      document.getElementById('closeCustomerModal').addEventListener('click', () => {
        document.getElementById('customerInfoModal').style.display = 'none';
      });

      document.getElementById('cancelCustomerInfo').addEventListener('click', () => {
        document.getElementById('customerInfoModal').style.display = 'none';
      });

      document.getElementById('confirmCustomerInfo').addEventListener('click', () => {
        const name = document.getElementById('customerName').value.trim();
        const phone = document.getElementById('customerPhone').value.trim();
        
        if (!name) {
          alert('请输入姓名');
          return;
        }
        
        if (!phone) {
          alert('请输入手机号');
          return;
        }
        
        if (!validatePhone(phone)) {
          alert('请输入有效的手机号');
          return;
        }
        
        // 导出选品清单
        exportSelectedWithCustomerInfo(name, phone);
        document.getElementById('customerInfoModal').style.display = 'none';
        
        // 清空表单
        document.getElementById('customerName').value = '';
        document.getElementById('customerPhone').value = '';
      });
      
      document.getElementById('clearFilters').addEventListener('click', clearAllFilters);
      
      document.getElementById('filterToggle').addEventListener('click', toggleFilters);

      document.getElementById('cartModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('cartModal')) {
          document.getElementById('cartModal').style.display = 'none';
        }
      });

      document.getElementById('customerInfoModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('customerInfoModal')) {
          document.getElementById('customerInfoModal').style.display = 'none';
        }
      });

      // 返回顶部按钮逻辑
      const backToTopBtn = document.getElementById('backToTop');
      window.addEventListener('scroll', () => {
        if (window.pageYOffset > 300) {
          backToTopBtn.classList.add('visible');
        } else {
          backToTopBtn.classList.remove('visible');
        }
      });
      
      backToTopBtn.addEventListener('click', () => {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });

      // 窗口大小变化时调整筛选区显示
      window.addEventListener('resize', () => {
        if (window.innerWidth > 768) {
          // 在大屏幕上确保筛选区展开
          document.getElementById('filtersContainer').classList.remove('collapsed');
          document.getElementById('filterToggleIcon').className = 'fas fa-chevron-up';
        } else {
          // 在小屏幕上默认折叠
          document.getElementById('filtersContainer').classList.add('collapsed');
          document.getElementById('filterToggleIcon').className = 'fas fa-chevron-down';
        }
      });

      // 小屏幕默认折叠筛选区
      if (window.innerWidth <= 768) {
        document.getElementById('filtersContainer').classList.add('collapsed');
        document.getElementById('filterToggleIcon').className = 'fas fa-chevron-down';
      }
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>